# 東京都公式アプリ AI音声対話機能 要件定義書
**Requirements Specification Document**

**文書情報**
- **文書名**: 東京都公式アプリ AI音声対話機能 要件定義書
- **版数**: 4.0
- **作成日**: 2025年1月
- **作成者**: AI開発チーム
- **備考**: ChatGPT/Claude方式セッション管理対応版

---

## 1. 業務要件／ビジネス要件

### 1.1 プロジェクト概要

#### 1.1.1 プロジェクト背景
東京都公式アプリにAI音声対話機能を追加し、都民・外国人住民・観光客が自然な音声またはテキストで行政情報にアクセスできる機能を実現する。

#### 1.1.2 ビジネスゴール
- **アクセシビリティ向上**: 音声による直感的な行政情報アクセス
- **多言語対応**: 外国人住民・観光客への行政サービス提供
- **業務効率化**: 窓口業務の負荷軽減と24時間対応
- **ユーザー満足度向上**: 既存アプリの機能拡張による利便性向上

#### 1.1.3 対象ユーザー
- **都民**: 日常的な行政情報取得
- **外国人住民**: 多言語での行政サービス利用
- **観光客**: 観光・災害情報の多言語取得

### 1.2 機能要件

#### 1.2.1 基本機能要件
- **音声対話機能**: 自然言語での音声入力・出力
- **テキスト対話機能**: チャット形式でのテキスト入力・出力
- **多言語対応**: 日本語、英語、中国語、韓国語の4言語
- **行政情報検索**: 育児・災害・行政データのRAG検索
- **セッション管理**: ChatGPT/Claude方式の継続対話機能

#### 1.2.2 詳細機能要件

**音声処理機能**
- リアルタイム音声認識（Gemini Live API）
- 自然言語音声合成（Gemini Live API）
- 音声品質最適化（ノイズ除去・音量調整）

**対話管理機能**
- セッション継続性（1回のセッションで複数対話）
- コンテキスト制限対応（トークン制限内での履歴管理）
- 履歴保持（対話の文脈維持）
- セッション終了（ユーザーによる任意終了）
- 履歴クリア（手動クリア機能）
- 履歴エクスポート（外部保存機能）

**情報検索機能**
- ベクトル検索（Vertex Vector Search）
- 関連情報取得（RAG処理）
- 検索結果ランキング
- 検索履歴管理

#### 1.2.3 業務フロー要件

**現状（As-Is）業務フロー**
- 窓口相談：区役所・都庁窓口訪問（平均30分待機）
- 電話相談：コールセンター電話（平均10分待機）
- Web検索：公式サイト閲覧・検索

**新規（To-Be）業務フロー**
- 東京都公式アプリアクセス
- 音声/テキスト入力方式選択
- 4言語（日英中韓）での質問入力
- AIによる自動応答生成
- 音声+テキスト/テキストのみでの出力

### 1.3 データ要件

#### 1.3.1 対象データ
- **育児情報**: 保育園・幼稚園情報、子育て支援制度
- **災害情報**: 避難所情報、防災マニュアル、緊急連絡先
- **行政情報**: 手続き案内、申請方法、窓口情報

#### 1.3.2 データ管理要件
- **データ形式**: JSON/CSV形式
- **データ量**: 600件（PoC範囲）
- **更新頻度**: 手動更新（PoC範囲）
- **データ品質**: 正確性・最新性の保証

---

## 2. システム要件

### 2.1 対応環境要件

#### 2.1.1 対応OS・ブラウザ
- **iOS**: iOS 14.0以上
- **Android**: Android 8.0以上
- **ブラウザ**: Safari（iOS）、Chrome（Android）
- **PWA対応**: ホーム画面追加・オフライン対応

#### 2.1.2 動作保証端末
- **スマートフォン**: iPhone 8以上、Android 8.0以上搭載端末
- **タブレット**: iPad（iOS 14.0以上）、Android 8.0以上搭載タブレット
- **画面サイズ**: 4.7インチ以上（縦横比16:9推奨）

#### 2.1.3 ハードウェア要件
- **マイク**: 内蔵マイクまたは外部マイク
- **スピーカー**: 内蔵スピーカーまたは外部スピーカー
- **ネットワーク**: Wi-Fiまたはモバイル通信（4G/5G）
- **ストレージ**: 100MB以上の空き容量

### 2.2 パフォーマンス要件

#### 2.2.1 応答時間要件
- **音声認識**: 3秒以内（音声入力完了後）
- **テキスト応答**: 2秒以内（テキスト入力完了後）
- **音声合成**: 5秒以内（応答テキスト生成後）
- **検索処理**: 3秒以内（検索クエリ実行後）

#### 2.2.2 同時利用要件
- **同時接続数**: 100ユーザー（PoC範囲）
- **セッション数**: 200セッション（PoC範囲）
- **スループット**: 50リクエスト/分（PoC範囲）

#### 2.2.3 可用性要件
- **稼働率**: 99.5%以上（月間）
- **メンテナンス時間**: 月2時間以内
- **障害復旧時間**: 30分以内

### 2.3 技術要件

#### 2.3.1 フロントエンド技術要件
- **フレームワーク**: Next.js（PWA対応）
- **言語**: TypeScript
- **音声処理**: WebRTC + MediaRecorder API
- **状態管理**: React State
- **UI/UX**: レスポンシブデザイン

#### 2.3.2 バックエンド技術要件
- **フレームワーク**: Node.js（Express/Fastify）
- **言語**: TypeScript
- **API設計**: REST API + WebSocket
- **セッション管理**: Redis/メモリ
- **ログ管理**: Cloud Logging

#### 2.3.3 AI・音声処理技術要件
- **音声認識**: Gemini Live API
- **音声合成**: Gemini Live API
- **自然言語処理**: Gemini API
- **ベクトル検索**: Vertex Vector Search
- **Embedding**: Gemini Embedding API

---

## 3. 外部インターフェース要件

### 3.1 外部システム連携要件

#### 3.1.1 東京都オープンデータ連携
- **連携内容**: 育児・災害・行政データ取得
- **連携方式**: REST API
- **データ形式**: JSON/CSV
- **更新頻度**: 手動更新（PoC範囲）
- **認証方式**: API Key認証

#### 3.1.2 東京都データカタログ連携
- **連携内容**: データ更新通知・メタデータ取得
- **連携方式**: REST API
- **実装範囲**: 最小限実装（PoC範囲）

#### 3.1.3 将来連携予定システム
- **災害情報システム**: リアルタイム災害情報のRAG統合
- **SIP4D**: リアルタイム災害情報のベクトル化
- **交通システム**: リアルタイム交通情報のEmbedding
- **施設管理システム**: 施設情報のベクトル検索対応

### 3.2 API仕様要件

#### 3.2.1 REST API エンドポイント要件

| エンドポイント | メソッド | 機能 | リクエスト/レスポンス |
|----------------|----------|------|---------------------|
| `/api/chat` | POST | テキスト対話 | `{text, session_id}` → `{response}` |
| `/api/session` | GET | セッション取得 | `{session_id}` → `{history, status, language}` |
| `/api/session` | POST | セッション作成 | `{language}` → `{session_id, websocket_url}` |
| `/api/session` | DELETE | セッション終了 | `{session_id}` → `{status}` |
| `/api/session/clear` | POST | 対話履歴クリア | `{session_id}` → `{status}` |
| `/api/session/export` | GET | 対話履歴エクスポート | `{session_id}` → `{history_data}` |
| `/api/health` | GET | ヘルスチェック | - → `{status, timestamp}` |
| `/api/languages` | GET | 対応言語一覧 | - → `{languages: []}` |

#### 3.2.2 WebSocket API エンドポイント要件

| エンドポイント | 機能 | メッセージ形式 |
|----------------|------|----------------|
| `/ws/voice/{session_id}` | 音声対話 | `{audio_data}` → `{text, audio_url, partial_text}` |
| `/ws/stream/{session_id}` | ストリーミング音声 | `{audio_chunk}` → `{partial_text}` |

### 3.3 ハードウェア要件

#### 3.3.1 サーバー要件
- **実行基盤**: Cloud Run（サーバーレス）
- **CPU**: 自動スケーリング
- **メモリ**: 2GB以上
- **ストレージ**: Cloud Storage（静的ファイル）
- **ネットワーク**: HTTPS通信必須

#### 3.3.2 クライアント要件
- **デバイス**: スマートフォン・タブレット
- **マイク**: 音声入力対応
- **スピーカー**: 音声出力対応
- **カメラ**: 不要
- **GPS**: オプション（位置情報連携）

---

## 4. 非機能要件

### 4.1 セキュリティ要件

#### 4.1.1 認証・認可要件
- **API認証**: JWT/API Key認証
- **セッション管理**: セッションIDによる認証
- **アクセス制御**: レート制限（50リクエスト/分）
- **データ暗号化**: HTTPS通信必須

#### 4.1.2 データ保護要件
- **個人情報**: 音声データの一時保存のみ
- **対話履歴**: セッション内でのみ保持
- **データ削除**: セッション終了時の自動削除
- **ログ管理**: アクセスログ・エラーログ記録

#### 4.1.3 プライバシー要件
- **音声データ**: 処理完了後の即座削除
- **対話内容**: セッション外への保存禁止
- **利用統計**: 匿名化された統計データのみ収集
- **同意管理**: 音声録音の明示的同意

### 4.2 可用性要件

#### 4.2.1 稼働要件
- **稼働率**: 99.5%以上（月間）
- **計画停止**: 月2時間以内
- **障害復旧**: 30分以内
- **バックアップ**: 日次自動バックアップ

#### 4.2.2 冗長性要件
- **サーバー冗長**: Cloud Run自動スケーリング
- **データ冗長**: Cloud Storage複数リージョン
- **ネットワーク冗長**: 複数AZ構成
- **障害検知**: 自動ヘルスチェック

### 4.3 拡張性要件

#### 4.3.1 スケーラビリティ要件
- **水平スケーリング**: 自動スケーリング対応
- **垂直スケーリング**: リソース動的調整
- **データ拡張**: ベクトルDB自動拡張
- **機能拡張**: モジュール化設計

#### 4.3.2 将来拡張要件
- **言語追加**: 多言語対応の拡張性
- **データ追加**: 新規データソース追加
- **機能追加**: 新機能の段階的追加
- **統合拡張**: 既存アプリとの完全統合

### 4.4 運用性要件

#### 4.4.1 監視要件
- **システム監視**: Cloud Monitoring
- **ログ監視**: Cloud Logging
- **パフォーマンス監視**: 応答時間・スループット
- **エラー監視**: エラー率・障害検知

#### 4.4.2 運用管理要件
- **デプロイ**: 自動デプロイ（CI/CD）
- **設定管理**: 環境変数による設定
- **バージョン管理**: Git管理
- **ドキュメント**: API仕様書・運用マニュアル

#### 4.4.3 保守性要件
- **コード品質**: TypeScript型安全性
- **テスト**: 単体テスト・統合テスト
- **ドキュメント**: 技術文書・ユーザーマニュアル
- **トレーサビリティ**: 要件→設計→実装の追跡

### 4.5 性能要件

#### 4.5.1 レスポンス要件
- **音声認識**: 3秒以内
- **テキスト応答**: 2秒以内
- **音声合成**: 5秒以内
- **検索処理**: 3秒以内

#### 4.5.2 スループット要件
- **同時接続**: 100ユーザー
- **リクエスト処理**: 50リクエスト/分
- **セッション管理**: 200セッション
- **データ処理**: 600件の検索対応

### 4.6 互換性要件

#### 4.6.1 既存システム互換性
- **東京都公式アプリ**: 既存アプリとの技術一貫性
- **データ形式**: 既存データ形式との互換性
- **API設計**: 既存API設計パターンとの統一
- **認証方式**: 既存認証システムとの連携

#### 4.6.2 標準準拠要件
- **Web標準**: HTML5、CSS3、JavaScript ES6+
- **PWA標準**: Service Worker、Web App Manifest
- **音声標準**: WebRTC、MediaRecorder API
- **セキュリティ標準**: HTTPS、CORS、CSP

---

## 付録

### A. 用語集

#### A.1 システム基盤用語
| 用語 | 定義 | 用途 |
|------|------|------|
| **RAG** | Retrieval Augmented Generation | 検索結果を活用した応答生成 |
| **ベクトル検索** | 意味的類似性による検索 | 関連情報の高精度検索 |
| **Embedding** | テキストのベクトル化 | 意味的類似性計算 |
| **静的データ** | 更新頻度の低いデータ | Cloud Storage + ベクトルDB構成 |
| **コンテキストウィンドウ** | AIモデルが処理できるテキスト量の制限 | 対話履歴の管理・制御 |
| **ロールリングウィンドウ** | 古い対話履歴を削除して新しい履歴を保持 | トークン制限内での履歴管理 |
| **トークン制限** | AIモデルの入力可能な文字数制限 | Gemini 2.0 Flash: 1,000,000トークン |
| **機能分担** | フロントエンド・バックエンドの役割分担 | システム設計の明確化 |
| **REST API** | REpresentational State Transfer API | HTTP通信ベースのAPI |
| **WebSocket API** | 双方向リアルタイム通信API | 音声データのストリーミング処理 |

#### A.2 AI・音声処理用語
| 用語 | 定義 | 用途 |
|------|------|------|
| **Gemini Live API** | Google Gemini音声処理API | 音声認識・合成 |
| **Gemini API** | Google Gemini自然言語処理API | テキスト生成・翻訳 |
| **Vertex Vector Search** | Google Cloud ベクトル検索サービス | 高精度類似検索 |
| **音声認識** | 音声→テキスト変換 | 音声入力処理 |
| **音声合成** | テキスト→音声変換 | 音声出力処理 |
| **多言語処理** | 複数言語の自動検出・翻訳 | 国際化対応 |

#### A.3 クラウド・インフラ用語
| 用語 | 定義 | 用途 |
|------|------|------|
| **Cloud Run** | Google Cloud サーバーレス実行環境 | バックエンド処理 |
| **Cloud Storage** | Google Cloud オブジェクトストレージ | 静的データ保存 |
| **Cloud Functions** | Google Cloud サーバーレス関数 | RAGパイプライン処理 |
| **サーバーレス** | インフラ管理不要の実行環境 | 運用負荷軽減 |

#### A.4 開発・UI用語
| 用語 | 定義 | 用途 |
|------|------|------|
| **Next.js** | Reactベースフルスタックフレームワーク | フロントエンド開発 |
| **PWA** | Progressive Web App | ネイティブアプリ体験 |
| **TypeScript** | 静的型付けJavaScript | 型安全性確保 |
| **Node.js** | JavaScript実行環境 | バックエンド開発 |
| **スマートフォン専用** | モバイルデバイス最適化UI | ユーザビリティ向上 |
| **WebRTC** | Web Real-Time Communication | 音声・動画通信 |
| **MediaRecorder API** | メディア録音API | 音声録音処理 |
| **Web Audio API** | Web音声処理API | 音声再生・処理 |
| **Service Worker** | バックグラウンド処理ワーカー | PWA機能実現 |

### B. 前提知識レベル

**必須**:
- 東京都公式アプリの基本機能理解
- スマートフォンアプリの利用経験
- 音声入力・出力の基本操作

**推奨**:
- TypeScript/JavaScript開発経験
- クラウドサービス利用経験
- AI・音声処理技術の基本理解

**参考**:
- PWA開発経験
- ベクトル検索技術理解
- 多言語対応システム経験

### C. 文書情報

**版数管理**:
- **1.0**: 初版（デスクトップアプリ版）
- **2.0**: 既存アプリ統合版
- **3.0**: スマートフォン対応版
- **4.0**: ChatGPT/Claude方式セッション管理対応版

**更新履歴**:
- 2025年1月: 初版作成
- 2025年1月: 既存アプリ技術スタック対応
- 2025年1月: スマートフォンPoC対応
- 2025年1月: セッション管理方式改善